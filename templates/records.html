{% extends "base.html" %}
{% block content %}

<section class="card">
  <div class="row-between">
    <h1>教學記錄｜{{ cat }}</h1>
    <div class="badge">代碼：<strong>{{ code }}</strong></div>
  </div>

  <!-- 類別切換 + 下載 both -->
  <div class="btnrow">
    <a class="btn {{ '' if cat=='定向' else 'btn-secondary' }}"
       href="{{ url_for('records', code=code, cat='定向') }}">定向</a>

    <a class="btn {{ '' if cat=='生活' else 'btn-secondary' }}"
       href="{{ url_for('records', code=code, cat='生活') }}">生活</a>

    <a class="btn btn-secondary"
       href="{{ url_for('export', code=code, cat='both') }}">下載 both</a>
  </div>

  <!-- 導航 + 本類別下載 -->
  <div class="btnrow">
    <a class="btn btn-secondary" href="{{ url_for('home') }}">回首頁</a>

    <button class="btn btn-secondary"
            type="button"
            id="downloadBtn"
            data-code="{{ code }}"
            data-download-url="{{ url_for('export', code=code, cat=cat) }}"
            data-home-url="{{ url_for('home') }}">
      下載（同檔含目標+記錄）
    </button>

    <a class="btn" href="{{ url_for('objectives', code=code, cat=cat) }}">⬅️ 前往教學目標</a>
  </div>
</section>

<section class="card">
  <h2 class="h2">新增一次教學記錄</h2>

  <form method="post" class="form">
    <input type="hidden" name="action" value="add" />
    <input type="hidden" name="cat" value="{{ cat }}" />

    <label class="label" for="teach_date">教學日期（年月日）</label>
    <input id="teach_date" name="teach_date" class="input" type="date" value="{{ today }}" required />

    <label class="label" for="teach_time">教學時間（例如：14:00-16:00）</label>
    <input id="teach_time" name="teach_time" class="input" placeholder="14:00-16:00" required />

    <label class="label" for="effectiveness">教學成效評估（多行）</label>
    <textarea id="effectiveness" name="effectiveness" class="textarea" rows="5"
      placeholder="今天做了什麼、學生反應、成功/卡關點、下次建議..."></textarea>

    <div class="btnrow">
      <button class="btn" type="submit">新增</button>
    </div>
  </form>
</section>

<section class="card">
  <h2 class="h2">已新增的記錄（第1次～第N次）</h2>

  {% if records %}
    <div class="list">
      {% for r in records %}
        <div class="list-item">
          <div class="list-head">
            <div class="list-title">（暫編）第{{ loop.index }}次｜{{ r['teach_date'] }}｜{{ r['teach_time'] }}</div>

            <form method="post" class="inline">
              <input type="hidden" name="action" value="delete" />
              <input type="hidden" name="rec_id" value="{{ r['id'] }}" />
              <input type="hidden" name="cat" value="{{ cat }}" />
              <button class="btn btn-danger btn-small" type="submit">刪除</button>
            </form>
          </div>

          <pre class="pre">{{ r['effectiveness'] }}</pre>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="hint">目前還沒有任何記錄。你可以先新增第1次。</p>
  {% endif %}
</section>

<!-- 下載後詢問是否刪除草稿（Step 3） -->
<div id="afterDownloadBackdrop" class="modal-backdrop" style="display:none;"></div>

<div id="afterDownloadModal"
     class="modal"
     style="display:none;"
     role="dialog"
     aria-modal="true"
     aria-labelledby="afterDownloadTitle">

  <div class="modal-card">
    <div class="toast-title" id="afterDownloadTitle">已下載完成 ✅</div>
    <p class="modal-desc">要刪除這份草稿嗎？（可避免雲端暫存越來越多）</p>

    <div class="btnrow">
      <button class="btn btn-danger" type="button" id="deleteAfterDownloadBtn">刪除草稿</button>
      <button class="btn btn-secondary" type="button" id="keepAfterDownloadBtn">先保留</button>
    </div>

    <p class="hint" style="margin-top:10px;">代碼：<code id="afterDownloadCode">{{ code }}</code></p>
  </div>
</div>

{% endblock %}